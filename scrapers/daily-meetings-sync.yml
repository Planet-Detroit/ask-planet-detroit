name: Daily Meeting Scraper

on:
  # Run every day at 6 AM EST (11:00 UTC)
  schedule:
    - cron: '0 11 * * *'
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      scraper:
        description: 'Which scraper to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - mpsc
          - glwa
          - detroit
          - egle

jobs:
  scrape-meetings:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scrapers/requirements.txt
          playwright install chromium
          playwright install-deps chromium
      
      - name: Run meeting scrapers
        id: scrape
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd scrapers
          
          SCRAPER="${{ github.event.inputs.scraper || 'all' }}"
          
          if [ "$SCRAPER" = "all" ]; then
            python run_scrapers.py 2>&1 | tee scrape_output.txt
          else
            python run_scrapers.py $SCRAPER 2>&1 | tee scrape_output.txt
          fi
          
          # Extract counts from output
          MPSC_COUNT=$(grep -oP 'MPSC: \K\d+' scrape_output.txt || echo "0")
          GLWA_COUNT=$(grep -oP 'GLWA: \K\d+' scrape_output.txt || echo "0")
          DETROIT_COUNT=$(grep -oP 'DETROIT: \K\d+' scrape_output.txt || echo "0")
          EGLE_COUNT=$(grep -oP 'EGLE: \K\d+' scrape_output.txt || echo "0")
          TOTAL=$(grep -oP 'TOTAL: \K\d+' scrape_output.txt || echo "0")
          
          # Check for errors
          if grep -q "ERROR" scrape_output.txt; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi
          
          echo "mpsc_count=$MPSC_COUNT" >> $GITHUB_OUTPUT
          echo "glwa_count=$GLWA_COUNT" >> $GITHUB_OUTPUT
          echo "detroit_count=$DETROIT_COUNT" >> $GITHUB_OUTPUT
          echo "egle_count=$EGLE_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
      
      - name: Create summary
        if: always()
        run: |
          echo "## Meeting Scraper Results ðŸ“…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run completed:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Agency | Meetings Found |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| MPSC | ${{ steps.scrape.outputs.mpsc_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GLWA | ${{ steps.scrape.outputs.glwa_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Detroit | ${{ steps.scrape.outputs.detroit_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EGLE | ${{ steps.scrape.outputs.egle_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.scrape.outputs.total_count }}** |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.scrape.outputs.has_errors }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Some errors occurred.** Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Notify Slack on success
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d @- <<EOF
          {
            "text": "ðŸ“… Daily Meeting Scraper Complete",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ðŸ“… Meeting Scraper Results"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*MPSC:*\n${{ steps.scrape.outputs.mpsc_count }} meetings"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*GLWA:*\n${{ steps.scrape.outputs.glwa_count }} meetings"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Detroit:*\n${{ steps.scrape.outputs.detroit_count }} meetings"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*EGLE:*\n${{ steps.scrape.outputs.egle_count }} meetings"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Total:*\n${{ steps.scrape.outputs.total_count }} meetings"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "âœ… Completed: $(date '+%b %d, %Y %I:%M %p') UTC"
                  }
                ]
              }
            ]
          }
          EOF
      
      - name: Notify Slack on failure
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d @- <<EOF
          {
            "text": "âŒ Meeting Scraper Failed",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "âŒ Meeting Scraper Failed"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "The daily meeting scraper encountered an error. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
                }
              }
            ]
          }
          EOF
